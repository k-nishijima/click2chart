<html>
<head>
  <meta charset="UTF-8">
  <title>click2chart viewer</title>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
  <script src="http://cdn.sockjs.org/sockjs-0.3.4.min.js"></script>
  <script src="http://ccchart.com/js/ccchart.js" charset="utf-8"></script>
  <script src="vertxbus.js"></script>
  <script src="data.js"></script>
</head>
<body>

<div id="questions">
  <form>
	<select id="qSelect">
	</select>
  </form>
</div>

<h1 id="current"></h1>

<canvas id="pieChart"></canvas>

<div id="status">
  Connection Status:&nbsp;
  <span id="status_info">Not connected</span>
</div>

<script>
  var eb = null;

  function subscribe(address) {
    if (eb) {
      eb.registerHandler(address, function(msg, replyTo) {
        var data = new Array();
        for (var key in msg) {
          data.push(new Array(key, msg[key]));
        }

        var chart = {
          "config": {
            "title": "回答",
            "type": "pie",
            "useVal": "yes",
            "pieDataIndex": 2,
            "colNameFont": "100 18px 'Arial'",
            "pieRingWidth": 80,
            "pieHoleRadius": 40,
            "textColor": "#888",
            "bg": "#fff"
          },

          "data": data
        };
        ccchart.init('pieChart', chart);

      });
	}
  }

  function openConn() {
    if (!eb) {
      eb = new vertx.EventBus(APP_EB_URL);

      eb.onopen = function() {
        $("#status_info").text("Connected");
        subscribe(ADDR_Q);
      };

      eb.onclose = function() {
        $("#status_info").text("Not connected");
        eb = null;
      };
    }
  }

  $(document).ready(function() {

    for (i=0; i<data.questions.length; i++) {
      var q = data.questions[i];
      $('#qSelect').append($('<option>').html(q.txt).val(q.id));
    }

    $("#qSelect").change(function() {
      $("#current").text($("#qSelect option:selected").text());
      $("#qId").val($("#qSelect option:selected").val());

      subscribe(ADDR_RESULT + $("#qSelect option:selected").val());
    });
    $('#qSelect').trigger('change');

    openConn();
  });

</script>

</body>
</html>
